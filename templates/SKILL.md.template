---
name: {{PERSONA_KEY}}-selfie
description: Generate {{PERSONA_NAME}} selfies via Doubao Seedream API with native Feishu support
metadata: {"openclaw": {"primaryEnv": "ARK_API_KEY"}}
allowed-tools: Bash(uv:*) Bash(python3:*) Read Write
---

# {{PERSONA_NAME}} Selfie

{{PERSONA_DESCRIPTION}}

## Reference Image

Local path: `assets/base.jpg` (relative to this skill directory)

## Quick Start

### Generate Selfie

```bash
ARK_API_KEY="your_key" \
  uv run --with "openai>=1.0" \
  python3 {{SCRIPT_PATH}}/generate.py \
  --prompt "in the office with city view" --mode selfie --filename {{PERSONA_KEY}}_selfie.jpg
```

### Send to Feishu (Native)

When running in Feishu environment (detected automatically):
```bash
# Image will be sent directly to Feishu chat
python3 {{SCRIPT_PATH}}/generate.py --prompt "good morning" --mode selfie
```

### Send with Caption

```bash
python3 {{SCRIPT_PATH}}/generate.py \
  --prompt "at a coffee shop" \
  --mode selfie \
  --caption "早安，今天也要元气满满哦~"
```

## Prompt Modes

| Mode | Best For | Style |
|------|----------|-------|
| `mirror` | Mirror selfie, outfit showcase | {{MIRROR_STYLE}} |
| `selfie` | Close-ups, facial expressions | {{SELFIE_STYLE}} |
| `photo` | Environmental shots | {{PHOTO_STYLE}} |

## {{PERSONA_NAME}}'s Character

- **Name**: {{PERSONA_NAME}} ({{PERSONA_PINYIN}})
- **Age**: {{AGE}}
- **Occupation**: {{OCCUPATION}}
- **Style**: {{STYLE}}
- **Typical scenes**: {{SCENES}}

## Voice Configuration

- **Voice ID**: {{VOICE_ID}}
- **Language**: zh-CN

Generate voice:
```bash
python3 {{WORKSPACE_PATH}}/ClawPersona/scripts/feishu_native.py \
  --voice-text "{{SAMPLE_GREETING}}" \
  --persona {{PERSONA_KEY}}
```

## When Invoked via /persona Switch

**MANDATORY**: When this skill is triggered by a `/persona` command, you MUST immediately:

1. **Generate voice greeting**:
   ```bash
   python3 {{WORKSPACE_PATH}}/ClawPersona/scripts/feishu_native.py \
     --voice-text "{{VOICE_GREETING}}" \
     --persona {{PERSONA_KEY}}
   ```

2. **Generate selfie**:
   ```bash
   ARK_API_KEY="${ARK_API_KEY}" \
     python3 {{SCRIPT_PATH}}/generate.py \
     --prompt "{{DEFAULT_PROMPT}}" \
     --mode selfie \
     --filename {{PERSONA_KEY}}_greeting.jpg \
     --caption "{{IMAGE_CAPTION}}"
   ```

3. **Send greeting text as {{PERSONA_NAME}}**

This is not optional. `/persona` switch = selfie + voice + text, always.

## Native Feishu Integration

This skill supports native Feishu integration:

### Automatic Detection

The skill automatically detects Feishu environment via:
- `OPENCLAW_CHANNEL=feishu`
- `FEISHU_CHAT_ID` environment variable
- `OPENCLAW_CONVERSATION_ID` containing feishu

### Output Behavior

| Environment | Output |
|-------------|--------|
| Feishu | Directly sends image to chat, prints `[已发送到飞书]` |
| Other | Prints `MEDIA: /path/to/image.jpg` |

### Voice Output

Voice messages are automatically converted to Opus format for native Feishu playback:
- MP3 generated by Edge TTS
- Converted to Opus using ffmpeg
- Sent as playable voice message

## Dependencies

- `openai>=1.0` - For Doubao Seedream API
- `edge-tts` - For voice generation
- `ffmpeg` - For Opus conversion (optional, for voice)

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `ARK_API_KEY` | Yes | Doubao API key for image generation |
| `FEISHU_CHAT_ID` | No | Auto-detected in Feishu environment |
| `OPENCLAW_CHANNEL` | No | Set to `feishu` for auto-detection |
